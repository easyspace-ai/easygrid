# 架构总览

## 🏗️ 系统架构

LuckDB 是一个现代化的多维表格数据库系统（类似 Airtable），采用 Go 语言开发，基于领域驱动设计（DDD）架构模式。

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Client Layer (前端)                        │
│              Web App / Mobile App / API Clients              │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTP / WebSocket / SSE
┌──────────────────────────▼──────────────────────────────────┐
│                  Interfaces Layer (接口层)                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ HTTP API │  │ WebSocket│  │   SSE    │  │   MCP    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│              Application Layer (应用层)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ UserService  │  │ TableService │  │RecordService │      │
│  │ FieldService │  │ ViewService  │  │ ...          │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│                  Domain Layer (领域层)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Entities │  │ Services │  │ ValueObj │  │ Events   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│            Infrastructure Layer (基础设施层)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │Database  │  │  Cache   │  │ Storage  │  │  PubSub  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 🛠️ 技术栈

### 核心框架

| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **语言** | Go | 1.23+ | 后端开发语言 |
| **Web框架** | Gin | v1.9.1 | HTTP路由和中间件 |
| **ORM** | GORM | v1.30.0 | 数据库ORM |
| **数据库** | PostgreSQL | - | 主数据库 |
| **数据库** | SQLite | - | 降级方案 |
| **缓存** | Redis | v9.3.0 | 缓存和消息队列 |
| **认证** | JWT | v5.2.0 | 用户认证 |

### 实时通信

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| **WebSocket** | gorilla/websocket | 实时双向通信 |
| **ShareDB** | 自实现 | 协作编辑协议 |
| **SSE** | 原生HTTP | 服务器推送事件 |

### 工具库

| 组件 | 用途 |
|------|------|
| **goja** | JavaScript运行时（JSVM） |
| **antlr4-go** | 公式表达式解析 |
| **viper** | 配置管理 |
| **zap** | 结构化日志 |
| **cobra** | CLI命令框架 |

## 🎯 设计原则

### 1. 领域驱动设计（DDD）

- **清晰的分层**: 接口层、应用层、领域层、基础设施层
- **领域模型**: 实体、值对象、领域服务、聚合根
- **业务逻辑内聚**: 核心业务逻辑在领域层

### 2. 依赖倒置

- **接口定义在领域层**: Repository接口、Service接口
- **实现在基础设施层**: 数据库实现、缓存实现
- **依赖注入**: 通过容器统一管理依赖

### 3. Schema隔离

- **每个Base独立Schema**: `bse_<base_id>`
- **每个Table独立物理表**: `tbl_<table_id>`
- **完全隔离**: 数据、权限、性能隔离

### 4. 可扩展性

- **插件系统**: JSVM支持JavaScript插件
- **钩子系统**: 支持业务钩子扩展
- **MCP协议**: 支持Model Context Protocol

## 📦 项目结构

```
server/
├── cmd/                    # 命令行入口
│   ├── server/            # 主服务器
│   ├── mcp-api-key/       # MCP API密钥工具
│   └── mcp-auth/          # MCP认证工具
├── internal/              # 内部代码
│   ├── application/       # 应用层（业务逻辑编排）
│   ├── domain/            # 领域层（核心业务模型）
│   ├── infrastructure/    # 基础设施层（数据库、缓存等）
│   ├── interfaces/        # 接口层（HTTP、WebSocket等）
│   ├── container/         # 依赖注入容器
│   ├── config/            # 配置管理
│   ├── commands/          # CLI命令
│   ├── jsvm/              # JavaScript运行时
│   ├── mcp/               # MCP协议支持
│   ├── realtime/          # 实时通信
│   └── sharedb/           # ShareDB实现
├── pkg/                   # 可复用包
│   ├── authctx/           # 认证上下文
│   ├── database/          # 数据库工具
│   ├── errors/            # 错误定义
│   ├── logger/            # 日志工具
│   └── response/          # 响应工具
├── migrations/            # 数据库迁移
├── hooks/                 # JavaScript钩子
├── plugins/               # JavaScript插件
└── config.yaml            # 配置文件
```

## 🔄 数据流

### 请求处理流程

```
1. HTTP请求
   ↓
2. 中间件处理（认证、限流、日志）
   ↓
3. 路由分发到Handler
   ↓
4. Handler调用Application Service
   ↓
5. Application Service编排Domain Service
   ↓
6. Domain Service操作Domain Entity
   ↓
7. Repository持久化到数据库
   ↓
8. 返回响应
```

### 实时协作流程

```
1. 客户端连接WebSocket/SSE
   ↓
2. ShareDB同步操作
   ↓
3. 操作广播到所有客户端
   ↓
4. 冲突检测和解决
   ↓
5. 状态同步
```

## 🚀 核心特性

### 1. 动态Schema

- 支持动态创建表、字段
- 字段类型可扩展
- 虚拟字段（Formula、Lookup、Rollup等）

### 2. 实时协作

- 多用户同时编辑
- 操作冲突检测
- 实时同步

### 3. 权限系统

- 空间级别权限
- Base级别权限
- 表级别权限
- 字段级别权限

### 4. 扩展性

- JavaScript插件系统
- 业务钩子系统
- MCP协议支持

## 📖 相关文档

- [分层架构详解](./ARCHITECTURE-LAYERS.md)
- [依赖注入容器](./ARCHITECTURE-DI.md)
- [数据库设计](./ARCHITECTURE-DATABASE.md)

---

**最后更新**: 2025-01-XX

