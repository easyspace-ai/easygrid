# 公式字段使用文档

## 目录

1. [概述](#概述)
2. [基本语法](#基本语法)
3. [字段引用](#字段引用)
4. [运算符](#运算符)
5. [数据类型](#数据类型)
6. [函数参考](#函数参考)
7. [使用示例](#使用示例)
8. [最佳实践](#最佳实践)
9. [常见问题](#常见问题)
10. [错误处理](#错误处理)

---

## 概述

公式字段（Formula Field）是一种强大的计算字段，允许你使用表达式来计算基于同一记录中其他字段的值。公式字段支持：

- **80个内置函数**：涵盖数值计算、文本处理、日期时间、逻辑判断、数组操作等
- **丰富的运算符**：算术运算、比较运算、逻辑运算等
- **字段引用**：通过字段名称引用同一记录中的其他字段
- **类型自动转换**：系统会自动处理数据类型转换
- **依赖自动识别**：系统自动识别公式依赖的字段，并在依赖字段更新时重新计算

### 支持的函数类别

系统共支持 **80个内置函数**，分为以下6个类别：

- **数值函数**（19个）：SUM, AVERAGE, MAX, MIN, ROUND, ABS 等
- **文本函数**（16个）：CONCATENATE, LEFT, RIGHT, UPPER, LOWER, TRIM 等
- **逻辑函数**（9个）：IF, AND, OR, NOT, SWITCH, XOR 等
- **日期时间函数**（25个）：TODAY, NOW, YEAR, MONTH, DAY, DATETIME_DIFF 等
- **数组函数**（7个）：COUNT, COUNTA, ARRAY_JOIN, ARRAY_UNIQUE 等
- **系统函数**（3个）：RECORD_ID, AUTO_NUMBER, TEXT_ALL 等

---

## 基本语法

### 表达式结构

公式表达式由以下元素组成：

```
表达式 = 字段引用 | 字面量 | 函数调用 | 运算符表达式
```

### 字段引用语法

使用花括号 `{}` 引用字段，支持使用字段名称：

```javascript
{字段名称}
```

**示例：**
```javascript
{价格} * {数量}              // 引用"价格"和"数量"字段
{姓名} & " 先生"              // 引用"姓名"字段并连接文本
IF({状态} = "已完成", "OK", "进行中")  // 条件判断中使用字段
```

**注意事项：**
- 字段名称必须与表中字段的实际名称完全匹配（区分大小写）
- 如果字段名称包含空格或特殊字符，需要用花括号包裹
- 系统会自动将字段ID映射为字段名称

### 字面量

#### 数字字面量

```javascript
123              // 整数
123.45           // 小数
-123             // 负数
0                // 零
```

#### 字符串字面量

使用单引号或双引号包裹字符串：

```javascript
"Hello World"   // 双引号
'Hello World'   // 单引号
"价格: "        // 中文文本
```

**转义字符：**
- `\n` - 换行符
- `\t` - 制表符
- `\\` - 反斜杠
- `\"` - 双引号
- `\'` - 单引号

#### 布尔字面量

```javascript
TRUE            // 真
FALSE           // 假
```

#### 日期时间字面量

日期时间需要使用函数创建，不能直接使用字面量（见日期时间函数章节）。

---

## 运算符

### 算术运算符

| 运算符 | 说明 | 示例 | 结果 |
|--------|------|------|------|
| `+` | 加法 | `10 + 5` | `15` |
| `-` | 减法 | `10 - 5` | `5` |
| `*` | 乘法 | `10 * 5` | `50` |
| `/` | 除法 | `10 / 5` | `2` |
| `%` | 取模 | `10 % 3` | `1` |
| `^` | 幂运算 | `2 ^ 3` | `8` |

**示例：**
```javascript
{单价} * {数量}                    // 计算总价
({数学} + {英语} + {语文}) / 3     // 计算平均分
{总价} - {折扣金额}                // 计算最终价格
```

### 比较运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `=` | 等于 | `{状态} = "已完成"` |
| `!=` 或 `<>` | 不等于 | `{状态} != "进行中"` |
| `>` | 大于 | `{分数} > 60` |
| `>=` | 大于等于 | `{年龄} >= 18` |
| `<` | 小于 | `{库存} < 100` |
| `<=` | 小于等于 | `{数量} <= 10` |

**示例：**
```javascript
IF({分数} >= 90, "优秀", IF({分数} >= 60, "及格", "不及格"))
```

### 逻辑运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `AND` | 逻辑与 | `{年龄} >= 18 AND {年龄} <= 65` |
| `OR` | 逻辑或 | `{状态} = "已完成" OR {状态} = "已确认"` |
| `NOT` | 逻辑非 | `NOT {已删除}` |

**示例：**
```javascript
IF({库存} > 0 AND {状态} = "上架", "可售", "不可售")
IF({性别} = "男" OR {年龄} >= 60, "特殊群体", "普通群体")
```

### 字符串连接运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `&` | 字符串连接 | `{姓} & {名}` |

**示例：**
```javascript
{省份} & {城市} & {区县}          // 拼接地址
"订单号: " & {订单号}             // 添加前缀
```

### 运算符优先级

运算符按以下优先级计算（从高到低）：

1. **括号** `()` - 最高优先级
2. **一元运算符** `-` (负号)
3. **幂运算** `^`
4. **乘除模** `*`, `/`, `%`
5. **加减** `+`, `-`
6. **比较运算符** `=`, `!=`, `<>`, `>`, `>=`, `<`, `<=`
7. **逻辑非** `NOT`
8. **逻辑与** `AND`
9. **逻辑或** `OR`
10. **字符串连接** `&` - 最低优先级

**使用括号改变优先级：**
```javascript
10 + 5 * 2        // 结果是 20（先算乘法）
(10 + 5) * 2     // 结果是 30（先算加法）
```

---

## 数据类型

公式字段支持以下数据类型：

### 数值类型 (Number)

包括整数和小数：

```javascript
123              // 整数
123.45           // 小数
-100             // 负数
```

**数值函数示例：**
```javascript
ROUND({价格}, 2)           // 保留2位小数
ABS({差值})                 // 绝对值
CEILING({数量})             // 向上取整
```

### 文本类型 (String)

字符串值：

```javascript
"Hello"          // 英文字符串
"你好"            // 中文字符串
{姓名}            // 引用字段（字段值为文本）
```

**文本函数示例：**
```javascript
UPPER({姓名})               // 转换为大写
LEFT({标题}, 10)            // 取前10个字符
CONCATENATE({姓}, {名})     // 连接字符串
```

### 布尔类型 (Boolean)

逻辑值：

```javascript
TRUE             // 真
FALSE            // 假
{已完成}          // 字段值为布尔类型
```

**布尔函数示例：**
```javascript
IF({已完成}, "完成", "进行中")
AND({条件1}, {条件2})
NOT {已删除}
```

### 日期时间类型 (DateTime)

日期和时间值，通常由函数生成：

```javascript
TODAY()          // 今天
NOW()            // 当前时间
{创建时间}        // 引用日期时间字段
```

**日期时间函数示例：**
```javascript
YEAR({创建时间})             // 提取年份
MONTH({创建时间})            // 提取月份
DATETIME_DIFF({结束}, {开始}, "day")  // 计算天数差
```

### 空值类型 (Null)

表示空值或未定义的值：

```javascript
BLANK()          // 返回空值
{可选字段}        // 字段为空时
```

**空值检查：**
```javascript
IF(BLANK({字段}), "未填写", {字段})
IF({字段} = BLANK(), 0, {字段})
```

---

## 函数参考

### 数值函数

#### SUM - 求和

计算所有参数的和。

**语法：**
```javascript
SUM(值1, 值2, ...)
```

**示例：**
```javascript
SUM({数学}, {英语}, {语文})           // 计算总分
SUM({价格1}, {价格2}, {价格3})        // 多个价格求和
SUM(10, 20, 30)                       // 结果: 60
```

**支持多值：** 是

---

#### AVERAGE - 平均值

计算所有参数的平均值。

**语法：**
```javascript
AVERAGE(值1, 值2, ...)
```

**示例：**
```javascript
AVERAGE({数学}, {英语}, {语文})       // 计算平均分
AVERAGE(10, 20, 30)                   // 结果: 20
```

**支持多值：** 是

---

#### MAX - 最大值

返回所有参数中的最大值。

**语法：**
```javascript
MAX(值1, 值2, ...)
```

**示例：**
```javascript
MAX({数学}, {英语}, {语文})           // 最高分
MAX(10, 20, 30)                       // 结果: 30
```

**支持多值：** 是

---

#### MIN - 最小值

返回所有参数中的最小值。

**语法：**
```javascript
MIN(值1, 值2, ...)
```

**示例：**
```javascript
MIN({数学}, {英语}, {语文})           // 最低分
MIN(10, 20, 30)                       // 结果: 10
```

**支持多值：** 是

---

#### ROUND - 四舍五入

将数值四舍五入到指定的小数位数。

**语法：**
```javascript
ROUND(数值, 小数位数)
```

**示例：**
```javascript
ROUND({价格}, 2)                      // 保留2位小数
ROUND(3.14159, 2)                     // 结果: 3.14
ROUND(3.14159, 0)                     // 结果: 3
```

**参数：**
- `数值`：要四舍五入的数值
- `小数位数`：可选，默认0

---

#### ROUNDUP - 向上取整

将数值向上取整到指定的小数位数。

**语法：**
```javascript
ROUNDUP(数值, 小数位数)
```

**示例：**
```javascript
ROUNDUP({价格}, 2)                    // 向上保留2位小数
ROUNDUP(3.141, 2)                    // 结果: 3.15
ROUNDUP(3.1, 0)                      // 结果: 4
```

---

#### ROUNDDOWN - 向下取整

将数值向下取整到指定的小数位数。

**语法：**
```javascript
ROUNDDOWN(数值, 小数位数)
```

**示例：**
```javascript
ROUNDDOWN({价格}, 2)                  // 向下保留2位小数
ROUNDDOWN(3.149, 2)                  // 结果: 3.14
ROUNDDOWN(3.9, 0)                    // 结果: 3
```

---

#### ABS - 绝对值

返回数值的绝对值。

**语法：**
```javascript
ABS(数值)
```

**示例：**
```javascript
ABS({差值})                           // 绝对值
ABS(-10)                              // 结果: 10
ABS(10)                               // 结果: 10
```

---

#### CEILING - 向上取整（到整数）

将数值向上取整到最接近的整数。

**语法：**
```javascript
CEILING(数值)
```

**示例：**
```javascript
CEILING({数量})                       // 向上取整
CEILING(3.1)                         // 结果: 4
CEILING(3.9)                         // 结果: 4
```

---

#### FLOOR - 向下取整（到整数）

将数值向下取整到最接近的整数。

**语法：**
```javascript
FLOOR(数值)
```

**示例：**
```javascript
FLOOR({数量})                         // 向下取整
FLOOR(3.1)                           // 结果: 3
FLOOR(3.9)                           // 结果: 3
```

---

#### SQRT - 平方根

计算数值的平方根。

**语法：**
```javascript
SQRT(数值)
```

**示例：**
```javascript
SQRT(16)                             // 结果: 4
SQRT({面积})                          // 计算平方根
```

---

#### POWER - 幂运算

计算底数的幂次方。

**语法：**
```javascript
POWER(底数, 指数)
```

**示例：**
```javascript
POWER(2, 3)                          // 结果: 8 (2^3)
POWER({边长}, 2)                      // 计算平方
POWER(10, {指数})                    // 计算10的幂
```

---

#### MOD - 取模

返回两个数相除的余数。

**语法：**
```javascript
MOD(被除数, 除数)
```

**示例：**
```javascript
MOD(10, 3)                           // 结果: 1
MOD({总数}, 100)                     // 求余数
```

---

#### INT - 取整数部分

返回数值的整数部分（截断小数部分）。

**语法：**
```javascript
INT(数值)
```

**示例：**
```javascript
INT(3.14159)                         // 结果: 3
INT({数量})                          // 取整数部分
```

---

#### EVEN - 向上取最接近的偶数

将数值向上取整到最接近的偶数。

**语法：**
```javascript
EVEN(数值)
```

**示例：**
```javascript
EVEN(3)                              // 结果: 4
EVEN(4)                              // 结果: 4
EVEN({数量})                         // 取偶数
```

---

#### ODD - 向上取最接近的奇数

将数值向上取整到最接近的奇数。

**语法：**
```javascript
ODD(数值)
```

**示例：**
```javascript
ODD(3)                               // 结果: 3
ODD(4)                               // 结果: 5
ODD({数量})                          // 取奇数
```

---

#### VALUE - 将文本转换为数值

将文本字符串转换为数值。

**语法：**
```javascript
VALUE(文本)
```

**示例：**
```javascript
VALUE("123")                         // 结果: 123
VALUE({价格文本})                     // 转换为数字
```

---

#### EXP - 自然指数

计算 e 的幂次方。

**语法：**
```javascript
EXP(指数)
```

**示例：**
```javascript
EXP(1)                               // 结果: 2.718...
EXP({指数})                          // 计算e的幂
```

---

#### LOG - 自然对数

计算数值的自然对数。

**语法：**
```javascript
LOG(数值)
```

**示例：**
```javascript
LOG(2.718)                           // 结果: 约1
LOG({数值})                          // 计算对数
```

---

### 文本函数

#### CONCATENATE - 连接字符串

连接多个字符串或值。

**语法：**
```javascript
CONCATENATE(值1, 值2, ...)
```

**别名：** `CONCAT`

**示例：**
```javascript
CONCATENATE({姓}, {名})              // 连接姓名
CONCATENATE("订单号: ", {订单号})     // 添加前缀
CONCAT("Hello", " ", "World")        // 结果: "Hello World"
```

**支持多值：** 是（多值会用逗号连接）

---

#### LEFT - 提取左侧字符

从字符串左侧提取指定数量的字符。

**语法：**
```javascript
LEFT(文本, 字符数)
```

**示例：**
```javascript
LEFT({姓名}, 1)                      // 提取姓（第一个字符）
LEFT("Hello", 3)                    // 结果: "Hel"
```

---

#### RIGHT - 提取右侧字符

从字符串右侧提取指定数量的字符。

**语法：**
```javascript
RIGHT(文本, 字符数)
```

**示例：**
```javascript
RIGHT({手机号}, 4)                   // 提取后4位
RIGHT("Hello", 3)                   // 结果: "llo"
```

---

#### MID - 提取中间字符

从字符串的指定位置提取指定数量的字符。

**语法：**
```javascript
MID(文本, 起始位置, 字符数)
```

**示例：**
```javascript
MID({身份证号}, 7, 8)                // 提取出生日期
MID("Hello", 2, 3)                  // 结果: "ell"（从第2个字符开始，取3个）
```

**注意：** 起始位置从1开始

---

#### UPPER - 转换为大写

将文本转换为大写。

**语法：**
```javascript
UPPER(文本)
```

**示例：**
```javascript
UPPER({姓名})                        // 转换为大写
UPPER("hello")                       // 结果: "HELLO"
```

---

#### LOWER - 转换为小写

将文本转换为小写。

**语法：**
```javascript
LOWER(文本)
```

**示例：**
```javascript
LOWER({姓名})                        // 转换为小写
LOWER("HELLO")                       // 结果: "hello"
```

---

#### TRIM - 去除首尾空格

去除文本首尾的空白字符。

**语法：**
```javascript
TRIM(文本)
```

**示例：**
```javascript
TRIM({姓名})                         // 去除空格
TRIM("  Hello  ")                    // 结果: "Hello"
```

---

#### LEN - 字符串长度

返回文本的字符长度。

**语法：**
```javascript
LEN(文本)
```

**示例：**
```javascript
LEN({姓名})                          // 计算长度
LEN("Hello")                         // 结果: 5
```

---

#### FIND - 查找字符串位置

在文本中查找子字符串的位置（区分大小写）。

**语法：**
```javascript
FIND(查找的文本, 被查找的文本, 起始位置)
```

**示例：**
```javascript
FIND("o", "Hello")                  // 结果: 5
FIND("o", "Hello", 3)               // 结果: 5（从第3个字符开始查找）
```

**注意：**
- 位置从1开始
- 区分大小写
- 如果未找到，返回错误

---

#### SEARCH - 查找字符串位置（不区分大小写）

在文本中查找子字符串的位置（不区分大小写）。

**语法：**
```javascript
SEARCH(查找的文本, 被查找的文本, 起始位置)
```

**示例：**
```javascript
SEARCH("o", "Hello")                // 结果: 5
SEARCH("O", "Hello")                // 结果: 5（不区分大小写）
```

---

#### REPLACE - 替换字符

替换文本中指定位置的字符。

**语法：**
```javascript
REPLACE(文本, 起始位置, 字符数, 新文本)
```

**示例：**
```javascript
REPLACE("Hello", 3, 2, "xx")        // 结果: "Hexxo"
REPLACE({手机号}, 4, 4, "****")      // 隐藏中间4位
```

---

#### SUBSTITUTE - 替换文本

替换文本中的所有指定字符串。

**语法：**
```javascript
SUBSTITUTE(文本, 旧文本, 新文本, 替换次数)
```

**示例：**
```javascript
SUBSTITUTE("Hello World", "l", "x")        // 结果: "Hexxo Worxd"
SUBSTITUTE("Hello World", "l", "x", 2)     // 结果: "Hexxo World"（只替换前2次）
```

**参数：**
- `替换次数`：可选，如果指定，只替换前N次

---

#### REPT - 重复文本

重复文本指定次数。

**语法：**
```javascript
REPT(文本, 重复次数)
```

**示例：**
```javascript
REPT("*", 5)                        // 结果: "*****"
REPT({符号}, {数量})                 // 重复符号
```

---

#### T - 转换为文本

将值转换为文本字符串。

**语法：**
```javascript
T(值)
```

**示例：**
```javascript
T(123)                              // 结果: "123"
T({数值})                           // 转换为文本
```

---

#### REGEXP_REPLACE - 正则表达式替换

使用正则表达式替换文本。

**语法：**
```javascript
REGEXP_REPLACE(文本, 正则表达式, 替换文本)
```

**示例：**
```javascript
REGEXP_REPLACE({手机号}, "(\d{3})\d{4}(\d{4})", "$1****$2")  // 隐藏中间4位
```

---

#### ENCODE_URL_COMPONENT - URL编码

对文本进行URL编码。

**语法：**
```javascript
ENCODE_URL_COMPONENT(文本)
```

**示例：**
```javascript
ENCODE_URL_COMPONENT("Hello World")  // 结果: "Hello%20World"
ENCODE_URL_COMPONENT({参数})         // URL编码
```

---

### 逻辑函数

#### IF - 条件判断

根据条件返回不同的值。

**语法：**
```javascript
IF(条件, 真值, 假值)
```

**示例：**
```javascript
IF({分数} >= 60, "及格", "不及格")
IF({状态} = "已完成", "是", "否")
IF({库存} > 0, {价格}, 0)
```

**嵌套IF：**
```javascript
IF({分数} >= 90, "优秀",
   IF({分数} >= 60, "及格", "不及格"))
```

---

#### AND - 逻辑与

所有条件都为真时返回真。

**语法：**
```javascript
AND(条件1, 条件2, ...)
```

**示例：**
```javascript
AND({年龄} >= 18, {年龄} <= 65)     // 年龄在18-65之间
AND({库存} > 0, {状态} = "上架")     // 同时满足两个条件
```

**支持多值：** 是

---

#### OR - 逻辑或

任意一个条件为真时返回真。

**语法：**
```javascript
OR(条件1, 条件2, ...)
```

**示例：**
```javascript
OR({状态} = "已完成", {状态} = "已确认")  // 满足任一状态
OR({库存} = 0, {已下架} = TRUE)         // 任一条件满足
```

**支持多值：** 是

---

#### NOT - 逻辑非

取反逻辑值。

**语法：**
```javascript
NOT(条件)
```

**示例：**
```javascript
NOT {已删除}                          // 未删除
NOT({状态} = "已完成")                 // 未完成
```

---

#### XOR - 异或

当true的个数为奇数时返回true。

**语法：**
```javascript
XOR(条件1, 条件2, ...)
```

**示例：**
```javascript
XOR({条件1}, {条件2})                // 异或运算
XOR(TRUE, TRUE)                     // 结果: FALSE
XOR(TRUE, FALSE)                   // 结果: TRUE
```

**支持多值：** 是

---

#### SWITCH - 多条件分支

根据表达式的值返回对应的结果。

**语法：**
```javascript
SWITCH(表达式, 值1, 结果1, 值2, 结果2, ..., 默认值)
```

**示例：**
```javascript
SWITCH({状态}, "已完成", "OK", "进行中", "处理中", "未知")
SWITCH({月份},
   1, "一月",
   2, "二月",
   3, "三月",
   "其他")
```

**注意：**
- 如果参数个数是偶数，最后一个参数是默认值
- 如果参数个数是奇数，没有匹配时返回null

---

#### BLANK - 空值

返回空值。

**语法：**
```javascript
BLANK()
```

**示例：**
```javascript
IF({字段} = "", BLANK(), {字段})    // 空字符串时返回空值
BLANK()                             // 返回null
```

---

#### ERROR - 返回错误

返回错误信息。

**语法：**
```javascript
ERROR(错误信息)
```

**示例：**
```javascript
IF({除数} = 0, ERROR("除数不能为0"), {被除数} / {除数})
ERROR("自定义错误")
```

---

#### IS_ERROR - 检查是否为错误

检查值是否为错误。

**语法：**
```javascript
IS_ERROR(值)
```

**示例：**
```javascript
IF(IS_ERROR({计算结果}), 0, {计算结果})
IS_ERROR(ERROR("错误"))            // 结果: TRUE
```

---

### 日期时间函数

#### TODAY - 今天

返回今天的日期（不含时间）。

**语法：**
```javascript
TODAY()
```

**示例：**
```javascript
TODAY()                             // 返回今天的日期
DATETIME_DIFF(TODAY(), {创建日期}, "day")  // 计算天数差
```

---

#### NOW - 当前时间

返回当前日期和时间。

**语法：**
```javascript
NOW()
```

**示例：**
```javascript
NOW()                               // 返回当前时间
DATETIME_DIFF(NOW(), {开始时间}, "hour")  // 计算小时差
```

---

#### YEAR - 提取年份

从日期时间中提取年份。

**语法：**
```javascript
YEAR(日期时间)
```

**示例：**
```javascript
YEAR({创建时间})                    // 提取年份
YEAR(TODAY())                       // 当前年份
```

---

#### MONTH - 提取月份

从日期时间中提取月份（1-12）。

**语法：**
```javascript
MONTH(日期时间)
```

**示例：**
```javascript
MONTH({创建时间})                   // 提取月份
MONTH(TODAY())                      // 当前月份
```

---

#### DAY - 提取日期

从日期时间中提取日期（1-31）。

**语法：**
```javascript
DAY(日期时间)
```

**示例：**
```javascript
DAY({创建时间})                     // 提取日期
DAY(TODAY())                        // 今天的日期
```

---

#### HOUR - 提取小时

从日期时间中提取小时（0-23）。

**语法：**
```javascript
HOUR(日期时间)
```

**示例：**
```javascript
HOUR({创建时间})                     // 提取小时
HOUR(NOW())                         // 当前小时
```

---

#### MINUTE - 提取分钟

从日期时间中提取分钟（0-59）。

**语法：**
```javascript
MINUTE(日期时间)
```

**示例：**
```javascript
MINUTE({创建时间})                   // 提取分钟
MINUTE(NOW())                       // 当前分钟
```

---

#### SECOND - 提取秒

从日期时间中提取秒（0-59）。

**语法：**
```javascript
SECOND(日期时间)
```

**示例：**
```javascript
SECOND({创建时间})                   // 提取秒
SECOND(NOW())                       // 当前秒
```

---

#### WEEKDAY - 星期几

返回日期是星期几（1=周日，2=周一，...，7=周六）。

**语法：**
```javascript
WEEKDAY(日期时间)
```

**示例：**
```javascript
WEEKDAY({创建时间})                  // 返回星期几
IF(WEEKDAY({日期}) = 1 OR WEEKDAY({日期}) = 7, "周末", "工作日")
```

---

#### WEEK_NUM - 周数

返回日期所在的周数（一年中的第几周）。

**语法：**
```javascript
WEEK_NUM(日期时间)
```

**示例：**
```javascript
WEEK_NUM({创建时间})                 // 返回周数
WEEK_NUM(TODAY())                    // 当前周数
```

---

#### DATETIME_DIFF - 日期时间差值

计算两个日期时间之间的差值。

**语法：**
```javascript
DATETIME_DIFF(结束时间, 开始时间, 单位)
```

**单位：** `"year"`, `"month"`, `"week"`, `"day"`, `"hour"`, `"minute"`, `"second"`

**示例：**
```javascript
DATETIME_DIFF({结束日期}, {开始日期}, "day")      // 天数差
DATETIME_DIFF(NOW(), {创建时间}, "hour")         // 小时差
DATETIME_DIFF({到期日期}, TODAY(), "day")        // 距离到期的天数
```

---

#### DATE_ADD - 日期加法

在日期时间上添加指定的时间间隔。

**语法：**
```javascript
DATE_ADD(日期时间, 数量, 单位)
```

**单位：** `"year"`, `"month"`, `"week"`, `"day"`, `"hour"`, `"minute"`, `"second"`

**示例：**
```javascript
DATE_ADD({创建日期}, 30, "day")      // 30天后
DATE_ADD(TODAY(), 1, "month")       // 1个月后
DATE_ADD({开始时间}, 2, "hour")      // 2小时后
```

---

#### FROM_NOW - 从现在起

计算从现在起的指定时间后的日期时间。

**语法：**
```javascript
FROM_NOW(数量, 单位)
```

**示例：**
```javascript
FROM_NOW(7, "day")                  // 7天后
FROM_NOW(1, "month")                 // 1个月后
FROM_NOW(2, "hour")                  // 2小时后
```

---

#### TO_NOW - 到现在

计算从现在起的指定时间前的日期时间。

**语法：**
```javascript
TO_NOW(数量, 单位)
```

**示例：**
```javascript
TO_NOW(7, "day")                     // 7天前
TO_NOW(1, "month")                    // 1个月前
TO_NOW(2, "hour")                     // 2小时前
```

---

#### IS_SAME - 是否相同

检查两个日期时间是否相同（可指定精度）。

**语法：**
```javascript
IS_SAME(日期时间1, 日期时间2, 精度)
```

**精度：** `"year"`, `"month"`, `"week"`, `"day"`, `"hour"`, `"minute"`, `"second"`

**示例：**
```javascript
IS_SAME({日期1}, {日期2}, "day")     // 是否同一天
IS_SAME({时间1}, {时间2}, "hour")    // 是否同一小时
```

---

#### IS_AFTER - 是否之后

检查第一个日期时间是否在第二个之后。

**语法：**
```javascript
IS_AFTER(日期时间1, 日期时间2)
```

**示例：**
```javascript
IS_AFTER({到期日期}, TODAY())        // 是否已过期
IS_AFTER({结束时间}, {开始时间})      // 结束时间是否在开始时间之后
```

---

#### IS_BEFORE - 是否之前

检查第一个日期时间是否在第二个之前。

**语法：**
```javascript
IS_BEFORE(日期时间1, 日期时间2)
```

**示例：**
```javascript
IS_BEFORE({开始日期}, TODAY())       // 是否已开始
IS_BEFORE({开始时间}, {结束时间})     // 开始时间是否在结束时间之前
```

---

#### DATESTR - 日期字符串

将日期时间转换为日期字符串。

**语法：**
```javascript
DATESTR(日期时间, 格式)
```

**格式示例：** `"YYYY-MM-DD"`, `"MM/DD/YYYY"`, `"DD/MM/YYYY"`

**示例：**
```javascript
DATESTR({创建时间}, "YYYY-MM-DD")    // "2024-01-01"
DATESTR(TODAY(), "YYYY年MM月DD日")   // "2024年01月01日"
```

---

#### TIMESTR - 时间字符串

将日期时间转换为时间字符串。

**语法：**
```javascript
TIMESTR(日期时间, 格式)
```

**格式示例：** `"HH:mm:ss"`, `"HH:mm"`

**示例：**
```javascript
TIMESTR({创建时间}, "HH:mm:ss")      // "14:30:00"
TIMESTR(NOW(), "HH:mm")              // "14:30"
```

---

#### DATETIME_FORMAT - 日期时间格式化

将日期时间格式化为指定格式。

**语法：**
```javascript
DATETIME_FORMAT(日期时间, 格式)
```

**格式示例：** `"YYYY-MM-DD HH:mm:ss"`

**示例：**
```javascript
DATETIME_FORMAT({创建时间}, "YYYY-MM-DD HH:mm:ss")
DATETIME_FORMAT(NOW(), "YYYY年MM月DD日 HH:mm")
```

---

#### DATETIME_PARSE - 解析日期时间字符串

将日期时间字符串解析为日期时间值。

**语法：**
```javascript
DATETIME_PARSE(日期时间字符串, 格式)
```

**示例：**
```javascript
DATETIME_PARSE("2024-01-01", "YYYY-MM-DD")
DATETIME_PARSE({日期文本}, "YYYY-MM-DD HH:mm:ss")
```

---

#### WORKDAY - 工作日

计算指定工作日数后的日期（排除周末）。

**语法：**
```javascript
WORKDAY(开始日期, 工作日数)
```

**示例：**
```javascript
WORKDAY({开始日期}, 5)               // 5个工作日后
WORKDAY(TODAY(), 10)                 // 10个工作日后
```

---

#### WORKDAY_DIFF - 工作日差值

计算两个日期之间的工作日数。

**语法：**
```javascript
WORKDAY_DIFF(结束日期, 开始日期)
```

**示例：**
```javascript
WORKDAY_DIFF({结束日期}, {开始日期})  // 工作日数
WORKDAY_DIFF(TODAY(), {创建日期})     // 已过去的工作日数
```

---

#### CREATED_TIME - 创建时间

返回记录的创建时间。

**语法：**
```javascript
CREATED_TIME()
```

**示例：**
```javascript
CREATED_TIME()                       // 记录创建时间
DATETIME_DIFF(NOW(), CREATED_TIME(), "day")  // 创建了多少天
```

---

#### LAST_MODIFIED_TIME - 最后修改时间

返回记录的最后修改时间。

**语法：**
```javascript
LAST_MODIFIED_TIME()
```

**示例：**
```javascript
LAST_MODIFIED_TIME()                 // 最后修改时间
DATETIME_DIFF(NOW(), LAST_MODIFIED_TIME(), "hour")  // 多久前修改
```

---

### 数组函数

#### COUNT - 计数

统计数值参数的数量（忽略空值和文本）。

**语法：**
```javascript
COUNT(值1, 值2, ...)
```

**示例：**
```javascript
COUNT({数学}, {英语}, {语文})        // 统计有值的字段数
COUNT(10, 20, "", 30)                // 结果: 3（忽略空字符串）
```

**支持多值：** 是

---

#### COUNTA - 计数非空值

统计所有非空参数的数量。

**语法：**
```javascript
COUNTA(值1, 值2, ...)
```

**示例：**
```javascript
COUNTA({字段1}, {字段2}, {字段3})    // 统计非空字段数
COUNTA(10, "20", "", 30)              // 结果: 3（文本也算）
```

**支持多值：** 是

---

#### COUNTALL - 计数所有值

统计所有参数的数量（包括空值）。

**语法：**
```javascript
COUNTALL(值1, 值2, ...)
```

**示例：**
```javascript
COUNTALL({字段1}, {字段2}, {字段3})  // 统计所有字段数
COUNTALL(10, "", 30)                  // 结果: 3
```

**支持多值：** 是

---

#### ARRAY_JOIN - 数组连接

将数组或多个值连接成字符串。

**语法：**
```javascript
ARRAY_JOIN(值1, 值2, ..., 分隔符)
```

**示例：**
```javascript
ARRAY_JOIN({标签1}, {标签2}, {标签3}, ", ")  // 用逗号连接
ARRAY_JOIN("A", "B", "C", "-")                // 结果: "A-B-C"
```

**支持多值：** 是

---

#### ARRAY_UNIQUE - 数组去重

去除数组中的重复值。

**语法：**
```javascript
ARRAY_UNIQUE(值1, 值2, ...)
```

**示例：**
```javascript
ARRAY_UNIQUE({标签1}, {标签2}, {标签1})  // 去重
ARRAY_UNIQUE(1, 2, 1, 3, 2)              // 结果: [1, 2, 3]
```

**支持多值：** 是

---

#### ARRAY_FLATTEN - 数组扁平化

将嵌套数组扁平化为一维数组。

**语法：**
```javascript
ARRAY_FLATTEN(数组)
```

**示例：**
```javascript
ARRAY_FLATTEN({嵌套数组})             // 扁平化
```

---

#### ARRAY_COMPACT - 数组压缩

移除数组中的空值和null值。

**语法：**
```javascript
ARRAY_COMPACT(数组)
```

**示例：**
```javascript
ARRAY_COMPACT({数组字段})             // 移除空值
```

---

### 系统函数

#### RECORD_ID - 记录ID

返回当前记录的ID。

**语法：**
```javascript
RECORD_ID()
```

**示例：**
```javascript
RECORD_ID()                          // 返回记录ID
CONCATENATE("记录ID: ", RECORD_ID())  // 拼接记录ID
```

---

#### AUTO_NUMBER - 自动编号

返回自动编号值。

**语法：**
```javascript
AUTO_NUMBER()
```

**示例：**
```javascript
AUTO_NUMBER()                        // 自动编号
```

---

#### TEXT_ALL - 所有文本

返回记录中所有文本字段的值。

**语法：**
```javascript
TEXT_ALL()
```

**示例：**
```javascript
TEXT_ALL()                           // 所有文本字段的值
```

---

## 使用示例

### 基础计算示例

#### 示例1：计算总价

```javascript
{单价} * {数量}
```

#### 示例2：计算折扣后价格

```javascript
{原价} * (1 - {折扣率})
```

#### 示例3：计算平均分

```javascript
({数学} + {英语} + {语文}) / 3
```

#### 示例4：计算加权平均分

```javascript
({数学} * 3 + {英语} * 2 + {语文} * 1) / (3 + 2 + 1)
```

---

### 条件判断示例

#### 示例1：成绩等级判断

```javascript
IF({分数} >= 90, "优秀",
   IF({分数} >= 80, "良好",
      IF({分数} >= 60, "及格", "不及格")))
```

#### 示例2：库存状态判断

```javascript
IF({库存} > 100, "充足",
   IF({库存} > 0, "不足", "缺货"))
```

#### 示例3：年龄段判断

```javascript
IF({年龄} < 18, "未成年",
   IF({年龄} < 60, "成年", "老年"))
```

#### 示例4：多条件判断

```javascript
IF(AND({年龄} >= 18, {年龄} <= 65), "可工作", "不可工作")
IF(OR({状态} = "已完成", {状态} = "已确认"), "已完成", "进行中")
```

---

### 文本处理示例

#### 示例1：拼接姓名

```javascript
{姓} & {名}
```

#### 示例2：拼接地址

```javascript
{省份} & {城市} & {区县} & {详细地址}
```

#### 示例3：格式化订单号

```javascript
"订单号: " & {订单号}
```

#### 示例4：提取手机号后4位

```javascript
RIGHT({手机号}, 4)
```

#### 示例5：提取姓名首字母

```javascript
LEFT({姓名}, 1)
```

#### 示例6：隐藏手机号中间4位

```javascript
LEFT({手机号}, 3) & "****" & RIGHT({手机号}, 4)
```

#### 示例7：格式化金额

```javascript
CONCATENATE("¥", ROUND({金额}, 2))
```

---

### 日期时间示例

#### 示例1：计算年龄

```javascript
YEAR(TODAY()) - YEAR({出生日期})
```

#### 示例2：计算工作天数

```javascript
WORKDAY_DIFF(TODAY(), {入职日期})
```

#### 示例3：计算到期天数

```javascript
DATETIME_DIFF({到期日期}, TODAY(), "day")
```

#### 示例4：判断是否过期

```javascript
IF(IS_AFTER(TODAY(), {到期日期}), "已过期", "未过期")
```

#### 示例5：计算到期日期（30天后）

```javascript
DATE_ADD(TODAY(), 30, "day")
```

#### 示例6：格式化日期

```javascript
DATETIME_FORMAT({创建时间}, "YYYY年MM月DD日")
```

#### 示例7：判断是否今天

```javascript
IS_SAME({日期}, TODAY(), "day")
```

---

### 数组计算示例

#### 示例1：统计有效字段数

```javascript
COUNT({字段1}, {字段2}, {字段3})
```

#### 示例2：统计所有字段数

```javascript
COUNTALL({字段1}, {字段2}, {字段3})
```

#### 示例3：连接标签

```javascript
ARRAY_JOIN({标签1}, {标签2}, {标签3}, ", ")
```

---

### 综合示例

#### 示例1：订单金额计算（含折扣和税费）

```javascript
ROUND(({单价} * {数量} * (1 - {折扣率})) * (1 + {税率}), 2)
```

#### 示例2：完整地址拼接

```javascript
IF(BLANK({详细地址}), 
   {省份} & {城市} & {区县},
   {省份} & {城市} & {区县} & {详细地址})
```

#### 示例3：计算距离到期还有多少工作日

```javascript
IF(IS_AFTER({到期日期}, TODAY()),
   WORKDAY_DIFF({到期日期}, TODAY()),
   "已过期")
```

#### 示例4：格式化订单信息

```javascript
CONCATENATE("订单", {订单号}, " - ", 
            IF({状态} = "已完成", "已完成", "进行中"),
            " - 金额: ¥", ROUND({总价}, 2))
```

#### 示例5：计算综合评分

```javascript
ROUND(({服务质量} * 0.4 + {价格} * 0.3 + {时效性} * 0.3), 1)
```

---

## 最佳实践

### 1. 字段命名

- **使用清晰的字段名称**：字段名称应该清晰描述其含义
- **避免使用特殊字符**：尽量避免在字段名称中使用特殊字符，如 `@`, `#`, `$` 等
- **避免使用保留字**：避免使用函数名作为字段名称（如 `SUM`, `IF` 等）

### 2. 表达式编写

- **使用括号明确优先级**：当表达式复杂时，使用括号明确运算顺序
- **格式化表达式**：对于复杂的表达式，可以适当换行和缩进以提高可读性
- **避免过深的嵌套**：IF函数嵌套最好不要超过3层，考虑使用SWITCH函数替代

### 3. 性能优化

- **避免重复计算**：如果多个公式字段引用相同的字段组合，考虑先创建一个中间公式字段
- **简化表达式**：尽量使用简单的表达式，避免过于复杂的计算
- **合理使用函数**：选择最合适的函数，避免不必要的类型转换

### 4. 错误处理

- **处理空值**：使用IF和BLANK函数处理可能的空值情况
- **检查除数**：在进行除法运算时，检查除数是否为0
- **验证输入**：在公式中验证输入值的有效性

**示例：**
```javascript
// 安全的除法运算
IF({除数} = 0, 0, {被除数} / {除数})

// 处理空值
IF(BLANK({字段}), 0, {字段})

// 验证输入
IF({分数} < 0 OR {分数} > 100, ERROR("分数必须在0-100之间"), {分数})
```

### 5. 测试和验证

- **测试边界情况**：测试空值、0值、负值等边界情况
- **验证计算结果**：创建公式后，验证计算结果是否正确
- **测试依赖关系**：确保依赖字段更新时，公式字段能正确重新计算

### 6. 文档化

- **添加注释**：如果公式表达式复杂，可以添加字段描述说明公式的逻辑
- **记录依赖关系**：记录公式字段依赖哪些字段，便于维护

---

## 常见问题

### Q1: 为什么公式字段返回空值？

**可能原因：**
1. 依赖字段为空
2. 公式表达式有语法错误
3. 数据类型不匹配
4. 函数调用失败

**解决方案：**
- 检查依赖字段是否有值
- 验证公式表达式的语法
- 检查数据类型是否匹配
- 查看错误日志获取详细错误信息

### Q2: 如何引用字段名称包含空格的字段？

使用花括号包裹字段名称：
```javascript
{字段名称}
```

如果字段名称包含特殊字符，系统会自动处理。

### Q3: 公式字段支持跨表引用吗？

**当前不支持**。公式字段只能引用同一记录中的其他字段。如果需要跨表数据，请使用：
- **Lookup字段**：从关联记录中查找字段值
- **Rollup字段**：对关联记录进行聚合计算

### Q4: 如何检查公式表达式是否有错误？

系统会在以下情况返回错误：
- 语法错误：表达式不符合语法规则
- 函数调用错误：函数参数不正确
- 类型错误：数据类型不匹配

错误信息会以 `#ERROR: 错误信息` 的格式返回。

### Q5: 公式字段支持循环依赖吗？

**不支持**。系统会自动检测循环依赖，如果检测到循环依赖，创建请求会被拒绝。

**示例：**
- 字段A：`{B} + 1`
- 字段B：`{A} + 1`
- 这会导致循环依赖错误

### Q6: 公式字段的计算顺序是什么？

系统使用拓扑排序算法确保依赖字段先于依赖它的字段计算。计算顺序基于字段依赖关系自动确定。

### Q7: 如何调试公式表达式？

**调试技巧：**
1. **逐步简化**：从简单表达式开始，逐步增加复杂度
2. **分段测试**：将复杂表达式拆分为多个简单的公式字段
3. **检查中间值**：使用中间公式字段存储中间计算结果
4. **查看错误信息**：错误信息会指出问题所在

### Q8: 公式字段会影响性能吗？

**影响性能的因素：**
- 依赖字段数量
- 表达式复杂度
- 函数调用数量
- 记录数量

**优化建议：**
- 避免创建过深的依赖链
- 简化表达式
- 合理使用缓存（系统自动处理）

---

## 错误处理

### 错误类型

公式字段可能返回以下类型的错误：

#### 1. 语法错误

**错误格式：** `#ERROR: syntax error: ...`

**原因：**
- 表达式不符合语法规则
- 括号不匹配
- 运算符使用错误

**示例：**
```javascript
{字段1} + {字段2  // 缺少右括号
{字段1} + * {字段2}  // 运算符错误
```

#### 2. 函数调用错误

**错误格式：** `#ERROR: function error: ...`

**原因：**
- 函数名称错误
- 函数参数数量不正确
- 函数参数类型不匹配

**示例：**
```javascript
SUM()  // 参数不足
MAX("text")  // 类型错误
```

#### 3. 字段引用错误

**错误格式：** `#ERROR: field not found: ...`

**原因：**
- 字段名称不存在
- 字段已被删除

**示例：**
```javascript
{不存在的字段}  // 字段不存在
```

#### 4. 除零错误

**错误格式：** `#ERROR: division by zero`

**原因：** 除数为零

**示例：**
```javascript
{被除数} / 0  // 除零错误
```

#### 5. 类型转换错误

**错误格式：** `#ERROR: type conversion failed: ...`

**原因：** 无法将值转换为所需类型

**示例：**
```javascript
VALUE("不是数字")  // 无法转换为数字
```

### 错误处理函数

#### IS_ERROR - 检查错误

```javascript
IF(IS_ERROR({计算结果}), "计算出错", {计算结果})
```

#### ERROR - 返回错误

```javascript
IF({除数} = 0, ERROR("除数不能为0"), {被除数} / {除数})
```

### 错误处理最佳实践

1. **预防性检查**：在进行可能出错的操作前，先检查条件
2. **提供默认值**：当计算出错时，提供合理的默认值
3. **记录错误信息**：使用ERROR函数返回有意义的错误信息
4. **测试边界情况**：测试空值、0值、负值等边界情况

**示例：**
```javascript
// 安全的除法运算
IF({除数} = 0 OR BLANK({除数}), 
   0, 
   {被除数} / {除数})

// 安全的类型转换
IF(IS_ERROR(VALUE({文本})), 
   0, 
   VALUE({文本}))

// 完整的错误处理
IF(IS_ERROR({计算结果}), 
   ERROR("计算失败: " & {计算结果}),
   {计算结果})
```

---

## 参考资源

- [虚拟字段支持文档](./virtual-fields.md) - 了解虚拟字段的完整支持情况
- [计算服务实现](../internal/application/calculation_service.go) - 查看计算服务的实现
- [公式计算器实现](../internal/domain/calculation/formula/) - 查看公式计算器的实现
- [函数注册表](../internal/domain/calculation/formula/functions/registry.go) - 查看所有支持的函数

---

## 更新日志

- **2024-01-01** - 初始版本文档
  - 完整的公式字段语法说明
  - 80个内置函数的详细参考
  - 丰富的使用示例
  - 最佳实践和常见问题
