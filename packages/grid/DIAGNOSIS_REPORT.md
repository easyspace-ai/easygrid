# 前端只显示一条记录问题诊断报告

## 问题描述
后端 API 返回多条记录（从网络请求可以看到返回了至少 2 条记录），但前端页面只显示一条记录。

## 已实施的修复

### 1. 添加详细调试日志
在 `loadRecords` 函数中添加了完整的调试日志：
- 字段映射状态（映射大小、字段ID、列ID）
- 原始记录数量和 IDs
- 转换后数据数量和 IDs
- 数据完整性和唯一性验证

### 2. 修复字段映射时机问题
- 添加了空映射检查：如果 `fieldMapping` 为空，会跳过加载并输出警告
- 确保 `loadRecords` 只在字段映射建立后执行

### 3. 修复数据转换逻辑
在 `transformRecordToTableData` 函数中：
- 确保正确处理 `null` 和 `undefined` 值
- 为缺失字段设置 `null`，确保所有记录都有相同的列结构
- 确保所有记录的 `id` 都被保留

### 4. 添加数据验证
在设置 `data` 状态前：
- 检查是否存在重复的 ID（如果有会输出错误日志）
- 验证转换后数量与原始数量是否匹配

### 5. 添加筛选逻辑调试
在 `filteredData` 的 `useMemo` 中添加调试日志：
- 输出原始数据数和筛选条件数
- 检测是否意外过滤数据

## 调试方法

### 1. 查看控制台日志
刷新页面后，查看浏览器控制台，应该能看到以下日志：

```
[loadRecords] 开始加载记录, tableId: xxx
[loadRecords] 字段映射状态: {...}
[loadRecords] 获取到原始记录数: X
[loadRecords] 原始记录 IDs: [...]
[loadRecords] 转换后数据数: X
[loadRecords] 转换后数据 IDs: [...]
[filteredData] 开始筛选，原始数据数: X
[filteredData] 筛选后数据数: X
```

### 2. 检查常见问题

#### 问题 A: 字段映射为空
**症状**：控制台看到 `[loadRecords] fieldMapping is empty, skipping record load`

**原因**：字段加载失败或尚未完成

**解决**：检查字段加载是否成功，查看 `[loadTableAndFields]` 相关日志

#### 问题 B: 数据转换后数量不匹配
**症状**：控制台看到 `[loadRecords] 错误：数据转换后数量不匹配！`

**原因**：数据转换过程中丢失了记录

**解决**：检查转换后的 IDs，查看是否有重复的 ID

#### 问题 C: 存在重复的 ID
**症状**：控制台看到 `[loadRecords] 警告：存在重复的 ID！`

**原因**：后端返回了相同 ID 的记录（这是后端数据问题）

**解决**：需要修复后端数据，确保每条记录有唯一的 ID

#### 问题 D: 筛选意外过滤了数据
**症状**：控制台看到 `[filteredData] 警告：没有筛选条件但数据数量不匹配！`

**原因**：筛选逻辑有问题

**解决**：检查 `applyFilters` 函数的逻辑

### 3. 网络请求检查
在开发者工具的 Network 标签中：
1. 找到 `records?page=1&perPage=100` 请求
2. 查看响应内容，确认返回的记录数量
3. 检查是否有分页，可能需要查看多页数据

### 4. 可能的根本原因

根据网络请求截图，后端返回了多条记录，但都共享同一个 ID (`rec_Wza6x7VDvMfMBCTdEA8Z7`)。这是问题的根源：

**如果多条记录有相同的 ID：**
- 在数据转换后，由于使用 ID 作为 key，后面的记录会覆盖前面的记录
- 最终只会保留一条记录

**解决方案：**
1. **后端修复**：确保每条记录有唯一的 ID（这是正确的解决方案）
2. **前端临时处理**：如果后端无法立即修复，可以使用数组索引或其他唯一标识符作为临时 key

## 最新修复（针对重复 ID 问题）

### 问题根源
根据网络请求截图，后端返回的多条记录共享同一个 ID (`rec_Wza6x7VDvMfMBCTdEA8Z7`)，这导致 React Table 认为它们是同一行，只显示一条记录。

### 解决方案
在 `loadRecords` 函数中添加了重复 ID 检测和修复逻辑：
1. **检测重复 ID**：在转换后验证是否存在重复的 ID
2. **生成临时唯一 ID**：如果发现重复 ID，为重复的记录生成唯一的临时 ID（格式：`{originalId}_duplicate_{count}_{index}`）
3. **保留原始 ID**：在修复后的数据中保留 `_originalId` 字段，用于后续操作（如更新、删除）
4. **所有记录都能显示**：确保即使 ID 重复，所有记录都能正确显示

### 修复后的行为
- ✅ 检测到重复 ID 时，会输出警告日志
- ✅ 自动为重复的记录生成唯一临时 ID
- ✅ 所有记录都能正确显示
- ✅ 保留原始 ID 信息（`_originalId`），不影响后续操作

## 下一步操作

1. 刷新页面，查看控制台日志
2. 确认是否检测到重复 ID 并被修复
3. 验证所有记录是否都能正确显示
4. **长期解决**：修复后端数据，确保每条记录有唯一的 ID（这是根本解决方案）

## 修复的代码文件

- `dice/src/components/demos/product-demo.tsx` - 添加调试日志、数据验证和重复 ID 修复逻辑
- `dice/src/services/recordService.ts` - 修复数据转换逻辑
